<!doctype html>
    {% block head %}
        {# Required meta tags #}
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        {% block styles %}
            {# Bootstrap CSS Setup #}
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
            {{ bootstrap.load_css() }}

            <style>
                .result-badge {
                    font-size: 1.1em;
                }
            </style>
        {% endblock %}

        <title>Equity Curve Optimizer</title>
    {% endblock %}

    {% block scripts %}
        {# Loads Bootstrap's embedded Javascript #}
        {{ bootstrap.load_js() }}

        <script>
            $(document).ready(function() {       

            // ID Constants
            let STARTING_BALANCE = 'startingBalance';
            let BASE_RISK = 'baseRisk';
            let RISK_TO_REWARD_RATIO = 'riskToRewardRatio';
            let WIN_RATE = 'winRate';
            let NUM_TRADES = 'numTrades';
            let NUM_SIMULATIONS = 'numSimulations';
            let NUM_RISK_LEVELS = 'numRiskLevels';
            let LOSS_MGT = 'lossMgt';
            let MAX_LOSSES = 'maxLosses';
            let WIN_MGT = 'winMgt';
            let MAX_WINS = 'maxWins';
            let CHART = 'chart';

            // Tracking Values
            let startingBalance = 100000;
            let baseRisk = 1000;
            let riskToRewardRatio = 2;
            let winRate = 50;
            let numTrades = 25;
            let numSimulations = 1;
            let numRiskLevels = 2;
            let lossMgt = 0;
            let maxLosses = 1;
            let winMgt = 0;
            let maxWins = 2;

            // Ajax URLs
            let UPDATE_CHART_URL = '/update_chart';

            // Reset the sliders/dropdowns to defaults in case of stale settings
            resetPageFields();

            $(`#${STARTING_BALANCE}`).change(function(event) {
                startingBalance = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${BASE_RISK}`).change(function(event) {
                baseRisk = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${RISK_TO_REWARD_RATIO}`).change(function(event) {
                riskToRewardRatio = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${WIN_RATE}`).change(function(event) {
                winRate = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${NUM_TRADES}`).change(function(event) {
                numTrades = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${NUM_SIMULATIONS}`).change(function(event) {
                numSimulations = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${NUM_RISK_LEVELS}`).change(function(event) {
                numRiskLevels = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${LOSS_MGT}`).change(function(event) {
                lossMgt = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${MAX_LOSSES}`).change(function(event) {
                maxLosses = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${WIN_MGT}`).change(function(event) {
                winMgt = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });
            $(`#${MAX_WINS}`).change(function(event) {
                maxWins = event.target.value;
                updateChart(UPDATE_CHART_URL);
            });

            function prepareData() {
                let data = {
                    startingBalance: startingBalance,
                    baseRisk: baseRisk,
                    riskToRewardRatio: riskToRewardRatio,
                    winRate: winRate,
                    numTrades: numTrades,
                    numSimulations: numSimulations,
                    numRiskLevels: numRiskLevels,
                    lossMgt: lossMgt,
                    maxLosses: maxLosses,
                    winMgt: winMgt,
                    maxWins: maxWins
                };
                return data
            }

            function updateChart(url) {

                data = prepareData();

                // Build the ajax request
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: data,
                    success: function(response) {
                        console.log(response['message']);
                        $(`#${CHART}`).attr('src', `data:image/png;base64, ${response['plot']}`)
                    },
                    error: function(error) {
                        console.log('Error updating Chart.');
                        console.log(error);
                    }
                });
            }

            function resetPageFields() {
                ($(`#${STARTING_BALANCE}`).val() != startingBalance) ? $(`#${STARTING_BALANCE}`).val(startingBalance) : true;
                ($(`#${BASE_RISK}`).val() != baseRisk) ? $(`#${BASE_RISK}`).val(baseRisk) : true;
                ($(`#${RISK_TO_REWARD_RATIO}`).val() != riskToRewardRatio) ? $(`#${RISK_TO_REWARD_RATIO}`).val(riskToRewardRatio) : true;
                ($(`#${WIN_RATE}`).val() != winRate) ? $(`#${WIN_RATE}`).val(winRate) : true;
                ($(`#${NUM_TRADES}`).val() != numTrades) ? $(`#${NUM_TRADES}`).val(numTrades) : true;
                ($(`#${NUM_SIMULATIONS}`).val() != numSimulations) ? $(`#${NUM_SIMULATIONS}`).val(numSimulations) : true;
                ($(`#${NUM_RISK_LEVELS}`).val() != numRiskLevels) ? $(`#${NUM_RISK_LEVELS}`).val(numRiskLevels) : true;
                ($(`#${LOSS_MGT}`).val() != lossMgt) ? $(`#${LOSS_MGT}`).val(lossMgt) : true;
                ($(`#${MAX_LOSSES}`).val() != maxLosses) ? $(`#${MAX_LOSSES}`).val(maxLosses) : true;
                ($(`#${WIN_MGT}`).val() != winMgt) ? $(`#${WIN_MGT}`).val(winMgt) : true;
                ($(`#${MAX_WINS}`).val() != maxWins) ? $(`#${MAX_WINS}`).val(maxWins) : true;  
            }

        });
        </script>

    {% endblock %}

    {% block content %} 
        {# Application content needs to be provided in the app_content block #}
        {% block app_content %}
            <h1 class="text-center">Equity Curve Optimizer</h1>
            <br>
            <div class="container-fluid text-center">
                <div class="row text-center">
                    <div class="col-7">
                        <output> <img src="data:image/png;base64, {{ plot }}" alt="graph" width="150%" id="chart"> </output>
                    </div>
                    <div class="col-5">
                        <br>
                        <br>
                        <br>
                        {# Strategy Inputs Section #}
                        <div class="row my-1">
                            <div class="col-4 fs-2 text-left text-decoration-underline">Strategy Inputs:</div>
                        </div>                
                        <div class="row my-1 mx-5 align-items-center">
                            <div class="col-auto fs-3 text-left">Starting Balance ($):</div>
                            <div class="col-2">
                                <input type="text" class="form-control form-control-md" id="startingBalance" value="100000">
                            </div>
                        </div>
                        <div class="row my-1 mx-5 align-items-center">
                            <div class="col-auto fs-3 text-left">Risk: </div>
                            <div class="col-2">
                                <input type="text" class="form-control form-control-md" id="baseRisk" value="1000">
                            </div>
                            <div class="col-auto">
                                <select class="form-select form-select-md">
                                    <option value="$">$</option>
                                    <option value="%">%</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1 mx-5 text-left">
                            <label for="riskToRewardRatio" class="form-label fs-3">Risk-to-Reward Ratio: <output>2</output></label>
                            <input type="range" class="form-range" min="1" max="10" step="0.5" id="riskToRewardRatio" value="2" oninput="this.previousElementSibling.lastChild.value = this.value">
                        </div>                        
                        <div class="row my-1 mx-5 text-left">
                            <label for="winRate" class="form-label fs-3">Win Rate: <output>50</output>%</label>
                            <input type="range" class="form-range" min="1" max="100" id="winRate" value="50" oninput="this.previousElementSibling.firstChild.nextSibling.value = this.value">
                            
                        </div>
                        <div class="row my-1 mx-5 text-left">
                            <label for="numTrades" class="form-label fs-3"># of Trades: <output>25</output></label>
                            <input type="range" class="form-range" min="1" max="250" id="numTrades" value="25" oninput="this.previousElementSibling.lastChild.value = this.value">
                        </div>
                        <div class="row my-1 mx-5 text-left">
                            <label for="numSimulations" class="form-label fs-3"># of Simulations: <output>1</output></label>
                            <input type="range" class="form-range" min="1" max="10" id="numSimulations" value="1" oninput="this.previousElementSibling.lastChild.value = this.value">
                        </div>
                        <br>

                        {# Risk Management Section #}
                        <div class="row my-1">
                            <div class="col-4 fs-2 text-left text-decoration-underline">Risk Management:</div>
                        </div>
                        <div class="row my-1">
                            <div class="col-4 fs-3 text-end">Levels of Risk:</div>
                            <div class="col-auto">
                                <select class="form-select form-select-md" id="numRiskLevels">
                                    <option value="2">2: Full, 1/2</option>
                                    <option value="3">3: Full, 1/2, 1/4</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-4 fs-3 text-end">Loss Management:</div>
                            <div class="col-auto">
                                <select class="form-select form-select-md" id="lossMgt">
                                    <option value="0">None</option>
                                    <option value="1">Reduce risk after max consecutive losses</option>
                                    <option value="2">Reduce risk to lowest level after max consecutive losses</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-4 fs-3 text-end">Max Consecutive Losses:</div>
                            <div class="col-auto">
                                <select class="form-select form-select-md" id="maxLosses">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-4 fs-3 text-end">Win Management:</div>
                            <div class="col-auto">
                                <select class="form-select form-select-md" id="winMgt">
                                    <option value="0">None</option>
                                    <option value="1">Reduce risk after max consecutive wins</option>
                                    <option value="2">Reduce risk to lowest level after max consecutive wins</option>
                                </select>
                            </div>
                        </div>
                        <div class="row my-1">
                            <div class="col-4 fs-3 text-end">Max Consecutive Wins:</div>
                            <div class="col-auto">
                                <select class="form-select form-select-md" id="maxWins">
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {% endblock %}
    {% endblock %}
</html>